<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="cache-buster" content="v3-20260222-07">
  <title>Kira Chat v3 - 22 Feb 2026</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js?v=2"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js?v=2"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=2"></script>
  <script src="https://cdn.tailwindcss.com?v=2"></script>
  <style>
    body { background: #000; color: #fff; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { display: none; }
    
    /* Animazioni */
    @keyframes pulse-fast {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* iOS-style colors */
    .ios-blue { background: #0A84FF; }
    .ios-card { background: #1C1C1E; }
    .ios-gray { background: #1C1C1E; }
    .ios-gray-light { background: #2A2A2A; }
    
    /* Glass morphism */
    .glass {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Typing indicator */
    .typing {
      animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Icone SVG moderne
    const MicIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
        <path d="M12 1a3 3 0 0-3 3v11a3 3 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 2.73l-.22.38a2 2 0 0 2.73l-.15-.08a2 2 0 0 2.73.73l-.22-.39a2 2 0 0 0-.73.2.73l-.15-.09a2 2 0 0 1 1.74v-.51a2 2 0 0 1 1.74l-.15-.09a2 2 0 0 0-.73.2.73l-.22-.39a2 2 0 0 0-.73.2.73l-.15-.1a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 2 2h.44a2 2 0 0 0-2 2v-.18a2 2 0 0 1 1 1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73.2.73l-.15-.09a2 2 0 0 1 2 0l-.43.25a2 2 0 0 1 1.73V4a2 2 0 0 0 2 2z"/>
      </svg>
    );

    const SendIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
        <line x1="22" y1="2" x2="11" y2="22"/>
        <polygon points="22 2 15 22 11 15 11 13 2 13 2 11 22"/>
      </svg>
    );

    const SparkleIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
        <path d="M12 2l3.09 6.26L13 9.36a9 9 0 1 0-1.59-.93a3 3 0 0 1-3 3l-2.05 2.05a3 3 0 0 1 1 1.61l-2.05-2.05a3 3 0 0 0 1 1.59-.93a3 3 0 0 0-2.05L9.36 2.05a3 3 0 0 0 0 2.05L12.05 2.05a3 3 0 0 0 0 1.59-.93a3 3 0 0 0-2.05L13.59.93a3 3 0 0 0 0-3z"/>
      </svg>
    );

    const App = () => {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [isRecording, setIsRecording] = useState(false);
      const recognitionRef = useRef(null);
      const messagesEndRef = useRef(null);

      const recognitionRef = useRef(null);
      
      // Auto-scroll to latest message
      useEffect(() => {
        if (messagesEndRef.current) {
          messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [messages.length]);

      // Web Speech API Setup
      const startListening = () => {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('Il tuo browser non supporta Web Speech API');
          return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'it-IT';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          setInput(transcript);
        };

        recognition.onend = () => {
          setIsRecording(false);
        };

        recognition.start();
        setIsRecording(true);
        recognitionRef.current = recognition;
      };

      const stopListening = () => {
        if (recognitionRef.current) {
          recognitionRef.current.stop();
          recognitionRef.current = null;
        }
      };

      const send = async () => {
        const text = input.trim();
        if (!text) return;

        setLoading(true);
        const userMsg = { type: 'user', text, structured: isStructuredContent(text) };
        setMessages(prev => [...prev, userMsg]);
        setInput('');

        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, voiceEnabled: !userMsg.structured })
          });
          const data = await res.json();
          
          const aiMsg = { 
            type: 'ai', 
            text: data.response,
            structured: userMsg.structured,
            timestamp: new Date().toISOString()
          };
          
          setMessages(prev => [...prev, aiMsg]);
        } catch (e) {
          setMessages(prev => [...prev, { type: 'error', text: e.message }]);
        } finally {
          setLoading(false);
        }
      };

      const isStructuredContent = (text) => {
        return /```|https?:\/\/|www\.|`|\$|>|</.test(text);
      };

      return (
        <div className="min-h-screen flex flex-col p-4 max-w-2xl mx-auto">
          {/* Header */}
          <div className="flex justify-between items-center mb-6">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-full ios-blue flex items-center justify-center">
                <SparkleIcon />
              </div>
              <h1 className="text-xl font-semibold">Kira</h1>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => {
                  localStorage.clear();
                  window.location.reload();
                }}
                className="text-xs text-gray-400 flex items-center gap-1 px-2 py-1 rounded-lg border border-gray-700"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-3 h-3">
                  <path d="M3 6h18"/><path d="M19 6v14c0 1 1 2 2H7c-1 0 2-1-2V6"/><path d="M3 3v5h5"/><polyline points="17 8 12 3 7 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                <span>Cancella Cache</span>
              </button>
            </div>
          </div>

          {/* Chat Area */}
          <div className="flex-1 space-y-4 overflow-y-auto pb-28">
            {messages.length === 0 && (
              <div className="text-center text-gray-500 py-12">
                <div className="w-16 h-16 mx-auto mb-4 rounded-2xl ios-gray flex items-center justify-center">
                  <MicIcon />
                </div>
                <p className="text-sm">Ciao! Sono Kira, il tuo assistente.</p>
                <p className="text-xs text-gray-400">Scrivi o premi üéôÔ∏è per iniziare</p>
              </div>
            )}
            
            {messages.map((m, i) => (
              <div key={i} className={`flex ${m.type === 'user' ? 'justify-end' : 'justify-start'} animate-slideUp`}>
                <div className={`max-w-[85%] rounded-2xl p-4 ${
                  m.type === 'user' ? 'ios-blue' : 
                  m.type === 'error' ? 'bg-red-900/50' : 'ios-card'
                } backdrop-blur-sm`}>
                  {m.type === 'ai' && m.structured && (
                    <div className="text-xs text-green-400 mb-2 flex items-center gap-1">
                      <SparkleIcon size={14} />
                      <span>Contenuto strutturato</span>
                    </div>
                  )}
                  <div className="whitespace-pre-wrap text-sm leading-relaxed">{m.text}</div>
                </div>
              </div>
            ))}
            
            {loading && (
              <div className="flex justify-start">
                <div className="ios-card rounded-2xl p-4">
                  <div className="flex items-center gap-2">
                    <div className="typing w-2 h-2 rounded-full bg-gray-400"></div>
                    <div className="typing w-2 h-2 rounded-full bg-gray-400 animation-delay-200"></div>
                    <div className="typing w-2 h-2 rounded-full bg-gray-400 animation-delay-400"></div>
                    <span className="text-sm text-gray-300">Kira sta pensando...</span>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <div className="fixed bottom-0 left-0 right-0 p-4 glass safe-area-bottom">
            <div className="max-w-2xl mx-auto flex gap-3">
              {/* Mic Button */}
              <button
                onClick={() => isRecording ? stopListening() : startListening()}
                className={`p-3 rounded-2xl transition-all ${
                  isRecording ? 'bg-red-600 animate-pulse' : 'ios-gray hover:bg-gray-700'
                }`}
              >
                {isRecording ? (
                  <div className="w-5 h-5 rounded-full bg-red-400 animate-pulse"></div>
                ) : (
                  <MicIcon />
                )}
              </button>

              {/* Text Input */}
              <input
                value={input}
                onChange={e => setInput(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && send()}
                placeholder={isRecording ? "Ascoltando..." : "Scrivi o premi üéôÔ∏è"}
                className="flex-1 bg-black/50 border border-gray-800 rounded-2xl p-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm backdrop-blur-sm"
                disabled={isRecording}
              />

              {/* Send Button */}
              <button
                onClick={send}
                disabled={loading || !input.trim()}
                className="ios-blue p-3 rounded-2xl disabled:opacity-50 transition-all"
              >
                <SendIcon />
              </button>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
